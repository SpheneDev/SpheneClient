name: Test Build

on:
  workflow_dispatch:

jobs:
  testbuild:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout SpheneAPI
        uses: actions/checkout@v4
        with:
          repository: SpheneDev/SpheneAPI
          path: ./SpheneAPI
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout ShrinkU
        uses: actions/checkout@v4
        with:
          repository: SpheneDev/ShrinkU
          path: ./ShrinkU
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Download and install Dalamud
        run: |
          Invoke-WebRequest -Uri "https://goatcorp.github.io/dalamud-distrib/stg/latest.zip" -OutFile latest.zip
          Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"
        shell: powershell

      - name: Compute test build version
        id: compute
        run: |
          $headers = @{ 'Authorization' = 'Bearer ${{ secrets.GITHUB_TOKEN }}'; 'Accept' = 'application/vnd.github.v3+json' }
          try {
            $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest" -Headers $headers
            $base = ($latest.tag_name -replace '^v','')
          } catch {
            $base = '0.0.0'
          }
          $parts = $base.Split('.')
          if ($parts.Length -ge 3) {
            $base = "$($parts[0]).$($parts[1]).$($parts[2])"
          } else {
            $base = '0.0.0'
          }

          $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100" -Headers $headers
          $escaped = [Regex]::Escape($base)
          $pattern = "^v?$escaped\.(\d+)$"
          $numbers = @()
          foreach ($r in $releases) {
            $t = $r.tag_name
            if ($t -match $pattern) { $numbers += [int]$matches[1] }
          }
          if ($numbers.Count -gt 0) { $next = ($numbers | Measure-Object -Maximum).Maximum + 1 } else { $next = 1 }
          $newVersion = "$base.$next"
          $newTag = "v$newVersion"
          echo "version=$newVersion" >> $env:GITHUB_OUTPUT
          echo "tag=$newTag" >> $env:GITHUB_OUTPUT
          Write-Host "Base: $base Next build: $next => $newVersion ($newTag)"
        shell: powershell

      - name: Update project version
        run: |
          $version = "${{ steps.compute.outputs.version }}"
          $csprojPath = "Sphene/Sphene.csproj"
          $content = Get-Content $csprojPath -Raw
          $content = $content -replace '<Version>.*?</Version>', "<Version>$version</Version>"
          $content = $content -replace '<AssemblyVersion>.*?</AssemblyVersion>', "<AssemblyVersion>$version</AssemblyVersion>"
          $content = $content -replace '<FileVersion>.*?</FileVersion>', "<FileVersion>$version</FileVersion>"
          Set-Content $csprojPath $content
        shell: powershell

      - name: Restore
        run: dotnet restore Sphene.Actions.sln

      - name: Build Release
        run: dotnet build Sphene.Actions.sln --configuration Release --no-restore

      - name: Package
        id: package
        run: |
          $version = "${{ steps.compute.outputs.version }}"
          $outputDir = "Sphene-v$version"
          New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
          Get-ChildItem "Sphene/bin/x64/Release/" -File | Copy-Item -Destination $outputDir
          Get-ChildItem "Sphene/bin/x64/Release/" -Directory | Where-Object { $_.Name -ne 'Sphene' } | Copy-Item -Destination $outputDir -Recurse
          $zipName = "latest.zip"
          Compress-Archive -Path "$outputDir/*" -DestinationPath $zipName -Force
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Create GitHub release (test build)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.compute.outputs.tag }}
          name: Sphene Client Test Build v${{ steps.compute.outputs.version }}
          body: |
            Test build for Sphene Client v${{ steps.compute.outputs.version }}.
            Based on latest release ${{ steps.compute.outputs.version }} base.
          files: |
            ${{ steps.package.outputs.zip_name }}
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repo repository
        uses: actions/checkout@v4
        with:
          repository: SpheneDev/repo
          path: temp-repo
          token: ${{ secrets.REPO_ACCESS_TOKEN }}

      - name: Update testing fields in plogonmaster.json
        run: |
          cd temp-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          $jsonArray = Get-Content "plogonmaster.json" -Raw | ConvertFrom-Json

          $version = "${{ steps.compute.outputs.version }}"
          $tag = "${{ steps.compute.outputs.tag }}"
          $testingUrl = "https://github.com/SpheneDev/SpheneClient/releases/download/$tag/latest.zip"

          $spheneEntry = $jsonArray | Where-Object { $_.InternalName -eq 'Sphene' -or $_.Name -eq 'Sphene' }
          if ($null -eq $spheneEntry) { Write-Error "Sphene entry not found in plogonmaster.json"; exit 1 }

          $spheneEntry.DownloadLinkTesting = $testingUrl
          $spheneEntry.TestingAssemblyVersion = $version

          $jsonArray | ConvertTo-Json -Depth 10 | Set-Content "plogonmaster.json" -Encoding UTF8

          git add plogonmaster.json
          git commit -m "Update testing entries: $version"
          git push origin main
        shell: powershell